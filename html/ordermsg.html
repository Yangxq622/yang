<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>订单信息</title>
    <link href="../css/ordermsg.css" type="text/css" rel="stylesheet">
    <link href="../css/wrap.css" type="text/css" rel="stylesheet">
</head>
<body>
    <div class="box">
        <ul class="banner">
            <li class="banner1">电话咨询
               <div class="banner1-b">
                    <img src="../images/call.png">
                    <span>100-100-100</span>
               </div>
            </li>
            <li class="banner2">关注我们
                <div class="banner2-b">
                    <img src="../images/wx_03.gif">
                </div>
            </li>
            <li class="banner3">在线咨询</li>
            <li class="banner4"><a href="#top">返回顶部</a></li>
        </ul>
        <div class="header-box">
            <header>
                <div class="header-left">
                    <i></i>
                    <span>全场免运费</span>
                </div>
                <div class="header-right">
                    <div class="header-car">
                        <i></i>
                        <span>999件商品</span>
                    </div>
                    <div class="usermsg">
                        <a href="#">登录/注册</a>
                    </div>
                </div>
            </header>
        </div>
        <div class="middle-box">
            <div class="middle" id="#top">
                <h1>
                    <img src="../images/logo.png">
                </h1>
                <!-- <div class="nav">
                    <div class="nav-left">
                        <ul>
                            <li><a href="#">首页</a></li>
                            <li class="skin"><a href="#">护肤</a>
                                <div class="menu">
                                    <div class="menu1">
                                        <div class="menu1-top"><span>按系列</span></div>
                                            <ul class="menu1-ul">
                                                <li>
                                                    <a href="#"><img src="../images/18.png"></a>
                                                </li>
                                                <li>
                                                    <a href="#"><img src="../images/6.png"></a>
                                                </li>
                                                <li>
                                                    <a href="#"><img src="../images/24.png"></a>
                                                </li>
                                                <li>
                                                    <a href="#"><img src="../images/13.jpg"></a>
                                                </li>
                                                <li>
                                                    <a href="#"><img src="../images/14.png"></a>
                                                </li>
                                                <li>
                                                   <a href="#"> <img src="../images/25.png"></a>
                                                </li>
                                                <li>
                                                    <a href="#"><img src="../images/22.jpg"></a>
                                                </li>
                                                <li>
                                                    <a href="#"><img src="../images/11.jpg"></a>
                                                </li>
                                                <li>
                                                   <a href="#"> <img src="../images/1.jpg"></a>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="menu2">
                                            <div class="menu2-top"><span>按种类</span></div>
                                            <ul class="menu2-ul">
                                                <li><a href="#">卸妆清洁</a></li>
                                                <li><a href="#">爽肤水</a></li>
                                                <li><a href="#">精华</a></li>
                                                <li><a href="#">乳液</a></li>
                                                <li><a href="#">面霜</a></li>
                                                <li><a href="#">眼唇护理</a></li>
                                                <li><a href="#">面膜</a></li>
                                                <li><a href="#">护肤套装</a></li>
                                            </ul>
                                        </div>
                                        <div class="menu3">
                                            <div class="menu3-top"><span>按关心问题</span></div>
                                            <ul class="menu3-ul">
                                                <li><a href="#">干燥缺水</a></li>
                                                <li><a href="#">色斑暗沉</a></li>
                                                <li><a href="#">轻熟肌 弹性流失</a></li>
                                                <li><a href="#">熟龄肌 深度老化</a></li>
                                                <li><a href="#">毛孔粗大</a></li>
                                                <li><a href="#">眼周松弛</a></li>
                                            </ul>
                                        </div>
                                    </div>
                            </li>
                            <li class="makeup"><a href="#">彩妆</a>
                                    <div class="make">
                                        <div class="make1">
                                            <div class="make1-top"><span>按系列</span></div>
                                            <ul class="make1-ul">
                                                <li><a href="#"><img src="../images/9.jpg"></a></li>
                                                <li><a href="#"><img src="../images/eye.jpg"></a></li>
                                                <li><a href="#"><img src="../images/17.jpg"></a></li>
                                                <li><a href="#"><img src="../images/20.jpg"></a></li>
                                            </ul>
                                        </div>
                                        <div class="make2">
                                            <div class="make2-top"><span>面部</span></div>
                                            <ul class="make2-ul">
                                                <li><a href="#">妆前乳</a></li>
                                                <li><a href="#">粉底液</a></li>
                                                <li><a href="#">遮瑕</a></li>
                                                <li><a href="#">蜜粉</a></li>
                                                <li><a href="#">腮红</a></li>
                                            </ul>
                                        </div>
                                        <div class="make3">
                                            <div class="make3-top"><span>眼部</span></div>
                                            <ul class="make3-ul">
                                                <li><a href="#">眼影</a></li>
                                                <li><a href="#">眼线</a></li>
                                                <li><a href="#">睫毛膏</a></li>
                                                <li><a href="#">眉笔</a></li>
                                            </ul>
                                        </div>
                                        <div class="make4">
                                            <div class="make4-top"><span>唇部</span></div>
                                            <ul class="make4-ul">
                                                <li><a href="#">唇膏</a></li>
                                                <li><a href="#">唇线</a></li>
                                            </ul>
                                        </div>
                                        <div class="make5">
                                            <div class="make5-top"><span>彩妆其他</span></div>
                                            <ul class="make5-ul">
                                                <li><a href="#">粉盒</a></li>
                                                <li><a href="#">刷子</a></li>
                                                <li><a href="#">工具</a></li>
                                            </ul>
                                        </div>
                                    </div>
                            </li>
                            <li><a href="#">男士</a></li>
                            <li><a href="#">防晒</a></li>
                            <li><a href="#">香氛</a></li>
                            <li class="nine"><a href="#">官网臻享</a></li>
                            <li class="nine"><a href="#">明星产品</a></li>
                            <li class="nine"><a href="#">官网购物理由</a></li>
                            <li class="nine"><a href="#">品牌故事</a></li>
                            <li class="nine"><a href="#">专柜导航</a></li>
                        </ul>
                    </div>
                    <div class="nav-right">
                        <input type="text" id="search" placeholder="商品搜索">
                        <a href="#"><i></i></a>
                    </div>
                </div> -->
                <div class="pro">
                    <ul>
                        <li>
                            <span>购物车</span>
                            <i></i>
                        </li>
                        <li class="current">
                            <span>订单信息</span>
                            <i></i>
                        </li>
                        <li>
                            <span>确认及付款</span>
                            <i></i>
                        </li>
                        <li>
                            <span>完成</span>
                       </li>
                    </ul>
                </div>
                <div class="content">
                    <h3>填写并核对订单信息</h3>
                    <div class="msg">
                        <h4>收货人信息</h4>
                        <p>+新增收货地址</p>
                        <div class="username">
                            *收货人:<input type="text" id="username" required>
                        </div>
                        <div class="adress">
                            *所在地:
                            <select id="province">
                                <!-- <option></option> -->
                            </select>
                            <select id="city">
                                <!-- <option></option> -->
                            </select>
                            <select id="town">
                                <!-- <option></option> -->
                            </select>
                        </div>
                        <div class="x-adress">
                            *详细地址：<input type="text" id="x-adress" required> 
                        </div>
                        <div class="code">
                            *邮编:<input type="text" id="code" required>
                        </div>
                        <div class="tel">
                            *手机号码:<input type="text" id="tel" required>
                        </div>
                        <div class="phone">
                            固定电话：<input type="text" id="phone">
                        </div>
                       <div class="time">
                            收货时间:
                            <select id="time">
                                <option>无指定</option>
                                <option>周一到周五</option>
                                <option>周六</option>
                                <option>周日</option>
                            </select>
                       </div>
                        <span>确认收货信息</span>        
                    </div>
                    <div class="send-method">
                        <h4>配送方式</h4>
                        <input type="radio" name="send" class="send-opt" value="快递-中通">快递-中通
                        <input type="radio" name="send" class="send-opt" value="快递-顺丰">快递-顺丰
                        <span>保存</span>
                    </div>
                    <div class="pay-method">
                        <h4>支付方式</h4>
                        <input type="radio" name="pay" class="pay-opt" value="支付宝">支付宝
                        <input type="radio" name="pay" class="pay-opt" value="银联在线支付">银联在线支付
                        <span>保存</span>
                    </div>
                    <div class="invoice">
                        <h4>发票信息</h4>
                        <input type="radio" name="invoice" class="invoice-opt" value="不需要发票">不需要发票
                        <input type="radio" name="invoice" class="invoice-opt" value="公司发票">公司发票
                        <input type="radio" name="invoice" class="invoice-opt" value="个人发票">个人发票
                        <span>保存</span>
                    </div>
                    <div class="table">
                        <ul class="th">
                            <li class="goodsname">商品</li>
                            <li class="goodsprice">单价(元)</li>
                            <li class="goodsnum">数量</li>
                            <li class="sum">小计</li>
                        </ul>
                        <ul class="tbody">
                            <!-- <li>
                                <div class="x-name">
                                    <img src="../images/3.jpg">
                                    <span>快捷导航的数据库护肤的空间撒</span>
                                </div>
                                <div class="x-price">￥5555</div>
                                <div class="x-num">555</div>
                                <div class="x-sum">￥8888</div>
                            </li> -->
                        </ul>
                        <div class="result">
                            <span class="confirm">确定</span>
                            <div class="total-price">总价(免运费):<span></span></div>
                            <div class="integral">将获得积分:<span></span></div> 
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-box">
            <footer>
                <ul>
                    <li>
                        <a href="#">美容常见问题</a>
                    </li>
                    <li>
                        <a href="#">网站常见问题</a>
                    </li>
                    <li>
                        <a href="#">免责：隐私权保护</a>
                    </li>
                    <li>
                        <a href="#">联系我们</a>
                    </li>
                    <li>
                        <a href="#">服务条款</a>
                    </li>
                </ul>
                <span class="share">分享网站到</span>
                <a href="#"><i></i></a>
                <div class="footer-content">
                    <p>
                        Copyright(c) 2015资生堂(中国)投资有限公司；Shiseido China Co., Ltd. All rights reserved
                    </p>
                    <p>
                        沪ICP备10203872号-1 企业营业执照 SHISEIDO资生堂官方网站暨网上商城 全国咨询热线：400-821-6076
                    </p>
                    <p>
                       专柜以及促销信息查询→全国免费咨询热线： 800-820-1010
                    </p>
                    <p class="p4">
                        <i></i>
                        沪公网安备 31011502007430号
                    </p>
                </div>
            </footer>
        </div>
    </div>
</body>
<script src="../js/jquery-1.11.3.js"></script>
<script src="../js/function.js"></script>
<script src="../js/wrap.js"></script>
<script>
     //点击注册登录跳转
     $(".usermsg a").click(function(){
        window.location.href = "login.html";
    })
    //取cookie做登录名
    var userLoginId = getCookie("userLoginId");
    var username = getCookie("username");
    if(userLoginId){
        $(".usermsg a").html("欢迎"+username);
        $(".usermsg").append($("<span>退出</span>"));
        $(".usermsg span").click(function(){
            setCookie("userLoginId",userLoginId,-10);
            setCookie("username",username,-10);
            $(this).remove();
            $(".usermsg a").html("登录/注册");
            window.location.href = "login.html";
        })
        $(".usermsg a").append($("<a href='personal.html'>个人中心</a>"));
    }else{
        $(".usermsg a").html("登录/注册");
    }

    //显示购物车件数
    if(userLoginId){
        $.ajax({
            type:"get",
            url:"../php/getnumincar.php",
            data:{
                userLoginId:userLoginId
            },
            dataType:"json",
            success:function(result){
                $(".header-car span").html(result["num"] + "件商品");
            }
        })
    }else{
        $(".header-car span").html("请登录");
    }
    //点击进入购物车
    if(userLoginId){
        $(".header-right .header-car").click(function(){
            window.location.href = "payforgoods.html";
            })
    }else{
        wrapBox.init({
            width:300,
            height:70,
            headerTip:"提示",
            headerContent:`您还没有登录,是否立即登录`,
            cancelContent:{
                html:"是个游客",
                fn: function () {
                //更新数据库数据
                }
            },
            confirmContent:{
                html:"立即登录",
                    fn: function () {
                        window.location.href = "login.html"
                    }
                }
        })
    }
    //生成购物车列表内容
    var userLoginId = getCookie("userLoginId");
    // getData();
    function getData(){
        $.ajax({
            type:"get",
            url:"../php/shoppingcarlist.php",
            data:{
                userLoginId:userLoginId
            },
            dataType:"json",
            success:function(result){
                let html = "";
                $(".table .tbody")[0].innerHTML = "";
                result.map(function(item){
                    let id = item["id"];
                    let goodsimg = item["goodsimg"];
                    let goodsnum = item["goodsnum"];
                    let goodsname = item["goodsname"];
                    let goodsprice = item["goodsprice"];
                    html += `
                            <li>
                                <div class="x-name">
                                    <img src="../images/${goodsimg}">
                                    <span>${goodsname}</span>
                                </div>
                                <div class="x-price">${goodsprice}</div>
                                <div class="x-num">${goodsnum}</div>
                                <div class="x-sum">￥${(goodsnum*goodsprice).toFixed(2)}</div>
                            </li> 
                        `;
                })
                $(".table .tbody").append(html);
                // //总费用
                var sum = 0;
                var sumList = document.querySelectorAll(".x-sum");
                for(let i = 0 ;i<sumList.length;i++){
                    let item = sumList[i];
                    let length = item.length;
                    sum += (item.innerHTML.slice(1,length))*1;
                }
                var box = document.querySelector(".total-price span");
                box.innerHTML =  sum;
                var code = document.querySelector(".integral span");
                code.innerHTML = sum;
                  //点击结算
                var newCode = $(".integral span").html();
                $(".result .confirm").click(function(){
                   //支付成功再更新积分  删除购物车列表里对应用户的结算数据
                   $.ajax({
                       type:"get",
                       url:"../php/deleteorder.php",
                       data:{
                           userLoginId:userLoginId
                       },
                       dataType:"json",
                       success:function(result){
                           if(result["code"] == 1){
                               //结算成功 更新积分
                               $.ajax({
                                    type:"get",
                                    url:"../php/updatecode.php",
                                    data:{
                                        userLoginId:userLoginId,
                                        code:sum
                                    },
                                    dataType:"json",
                                    success:function(result){
                                        wrapBox.init({
                                            width:300,
                                            height:70,
                                            headerTip:"提示",
                                            headerContent:`即将跳转到首页`,
                                            cancelContent:{
                                                html:"不了",
                                                fn: function () {
                                                    window.location.href = "ordermsg.html";
                                                }
                                            },
                                            confirmContent:{
                                                html:"再逛逛",
                                                    fn: function () {
                                                        window.location.href = "index.html"
                                                    }
                                                }
                                            })
                                    }
})
                           }
                       }
                   })
                })
            }
        })
    }
    
    //点击提交 判断是否有空值  进行提示
    $(".content span").click(function(){
        //收货人名字
        var username = $("#username").val();
        var flag1;
        if(!username){
            flag1 = false;
        }else{
            flag1 = true;
        }
        //选择地址
        var flag2;
        let province = $("#province option:selected").html();
        let city = $("#city option:selected").html();
        let town = $("#town option:selected").html();
        if(!province || !city || !town){
            flag2 = false;
        }else{
            flag2 = true;
        }
        //详细地址
        var flag5;
        var adress = $("#x-adress").val();
        if(!adress){
            flag5 = false;
        }else{
            flag5 = true;
        }
        //邮编
        var flag3;
        var code = $("#code").val();
        if(!code){
            flag3 = false;
        }else{
            flag3 = true;
        }
        //手机号码
        var flag4;
        var tel = $("#tel").val();
        var usertel_reg = /^[1][3-9][0-9]{9}$/g;
        if(usertel_reg.test(tel)){
           flag4 = true;
        }else{
           flag4 = false;
        }
        //固定电话
        var phone = $("#phone").val();
        //收货时间
        var timer = $("#time option:selected").html();

        if((flag1 || flag2 || flag3 || flag4 || flag5) == false){
            wrapBox.init({
                    width:300,
                    height:70,
                    headerTip:"提示",
                    headerContent:`请检查您的所填信息`
            })
        }else{
            var html = "";
            html = `
                        <h4>收货人信息</h4>
                        <p>+新增收货地址</p>
                        <div class="username">
                            收货人:${username}
                        </div>
                        <div class="adress">
                            所在地:${province}省${city}市${town}
                        </div>
                        <div class="x-adress">
                            详细地址：${adress}
                        </div>
                        <div class="code">
                            邮编:${code}
                        </div>
                        <div class="tel">
                            手机号码:${tel}
                        </div>
                        <div class="phone">
                            固定电话：${phone}
                        </div>
                       <div class="time">
                            收货时间:
                            ${timer}
                       </div>
                `;
            $(".msg").html(html);
            getData();
        }
         //配送方式
    $(".send-method span").click(function(){
        var send_method = $(".send-method input:checked").val();
        if(send_method == undefined){
            wrapBox.init({
            width:300,
            height:70,
            headerTip:"提示",
            headerContent:`您还没有选择配送方式`
            })
        }else{
            var html = "";
            html +=`
                <h4>配送方式</h4>
                ${send_method}
                <span>保存</span>
            `;
            $(".send-method").html(html);
        }
    })
    })
    // //配送方式
    // $(".send-method span").click(function(){
    //     var send_method = $(".send-method input:checked").val();
    //     if(send_method == undefined){
    //         wrapBox.init({
    //         width:300,
    //         height:70,
    //         headerTip:"提示",
    //         headerContent:`您还没有选择配送方式`
    //         })
    //     }else{
    //         var html = "";
    //         html +=`
    //             <h4>配送方式</h4>
    //             ${send_method}
    //             <span>保存</span>
    //         `;
    //         $(".send-method").html(html);
    //     }
    // })
    //支付方式
    $(".pay-method span").click(function(){
        var pay_method = $(".pay-method input:checked").val();
        if(pay_method == undefined){
            wrapBox.init({
            width:300,
            height:70,
            headerTip:"提示",
            headerContent:`您还没有选择支付方式`
            })
        }else{
            var html = "";
            html +=`
                <h4>支付方式</h4>
                ${pay_method}
                <span>保存</span>
            `;
            $(".pay-method").html(html);
        }
    })
    //发票
    $(".invoice span").click(function(){
        var invoice = $(".invoice input:checked").val();
        if(invoice == undefined){
            wrapBox.init({
            width:300,
            height:70,
            headerTip:"提示",
            headerContent:`您是否需要开具发票`
            })
        }else{
            var html = "";
            html +=`
                <h4>发票</h4>
                ${invoice}
                <span>保存</span>
            `;
            $(".invoice").html(html);
        }
    })
    //选择地址
    var provinceSelect = document.getElementById("province");
    var citySelect = document.getElementById("city");
    var townSelect = document.getElementById("town");
    townSelect.style.display = "none";

    var req = new XMLHttpRequest();
    req.open("get", "http://api.yytianqi.com/citylist/id/2", true);
    req.send();
    req.onreadystatechange = function () {
        if (req.readyState == 4 && req.status == 200) {
            var result = req.responseText;
            var obj = JSON.parse(result);
            var list = obj["list"];//所有省份的集合
            var html = "<option value=''>请选择省份</option>";
            list.map(function (item) {//item就是一个个的省份信息
                var cityId = item["city_id"];
                var cityName = item["name"];
                html += `<option value="${cityId}">${cityName}</option>`;
            });
            provinceSelect.innerHTML = html;//省份的数据绑定成功

            provinceSelect.onchange = function () {
                var provinceId = this.value;
//                alert(provinceId);

                var cityList = list.filter(function (item) {
                    return item["city_id"] == provinceId;
                })[0]["list"];//找到指定省份下面所有的城市信息
                var html = "<option value=''>请选择城市</option>";
                cityList.forEach(function (item, index) {
//                    alert(item);
                    var cityId = item["city_id"];
                    var cityName = item["name"];
                    html += `<option value="${cityId}">${cityName}</option>`;
                });
                citySelect.innerHTML = html;


                citySelect.onchange = function () {
                    var cityId = this.value;
                    if (cityId) {
                        var cityInfo = cityList.filter(function (item) {
                            return item["city_id"] == cityId;
                        })[0];

                        if (cityInfo["list"]) {
                            var townList = cityInfo["list"];

                            var html = "<option value=''>请选择区/县</option>";
                            townList.map(function (item) {
                                var townId = item["city_id"];
                                var townName = item["name"];
                                html += `<option value="${townId}">${townName}</option>`;
                            });
                            townSelect.innerHTML = html;
                            townSelect.style.display = "inline-block";
                        } else {
                            townSelect.style.display = "none";
                        }
                    }
                }
            }
        }
    }
    //详细地址
    $("#x-adress").blur(function(){
        var adress = $("#x-adress").val();
        if(!adress){
            wrapBox.init({
                width:300,
                height:70,
                headerTip:"提示",
                headerContent:`详细地址更方便送货哦`
            })
        }
    })
</script>
</html>